version: 2.0
jobs:
  deploy_to_gce:
    working_directory: ~/rooms-booking
    environment:
      GOOGLE_PROJECT_ID: rooms-booking-177603
      GOOGLE_PROJECT_NAME: rooms-booking
      GOOGLE_CLUSTER_NAME: rooms-booking-staging
      GOOGLE_COMPUTE_ZONE: asia-northeast1-a
      CLOUD_SDK_VERSION: 171.0.0
    docker:
      - image: debian:jessie
    steps:
      - run:
          name: Install Google Cloud Sdk
          command: |
            sudo apt-get update -qqy && sudo apt-get install -qqy \
              curl \
              gcc \
              python-dev \
              python-setuptools \
              apt-transport-https \
              lsb-release \
              openssh-client \
              git \
            && easy_install -U pip && \
            pip install -U crcmod && \
            export CLOUD_SDK_REPO="cloud-sdk-$(lsb_release -c -s)" && \
            echo "deb https://packages.cloud.google.com/apt $CLOUD_SDK_REPO main" > /etc/apt/sources.list.d/google-cloud-sdk.list && \
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - && \
            sudo apt-get update && sudo apt-get install -y google-cloud-sdk=${CLOUD_SDK_VERSION}-0
      - run:
          name: Confirguration Google Cloud
          command: |
            gcloud --quiet components update
            gcloud --quiet components update kubectl
            echo $GOOGLE_AUTH | base64 --decode -i > ${HOME}/gcloud-service-key.json

            gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
            gcloud --quiet config set project $GOOGLE_PROJECT_ID
            gcloud --quiet config set container/cluster $GOOGLE_CLUSTER_NAME

            # Reading the zone from the env var is not working so we set it here
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
            gcloud --quiet container clusters get-credentials $GOOGLE_CLUSTER_NAME
      - run:
          name: Build the api image
          command: |
            docker build -f ./api/Dockerfile.circleci.staging --rm=false -t ${GOOGLE_PROJECT_NAME}-api:$CIRCLE_SHA1 .
            docker tag ${GOOGLE_PROJECT_NAME}-api:$CIRCLE_SHA1 asia.gcr.io/${GOOGLE_PROJECT_ID}/${GOOGLE_PROJECT_NAME}-api:$CIRCLE_SHA1
      - run:
          name: Deploy to google cloud
          command: |
            if [ "${CIRCLE_BRANCH}" == "develop" ]; then
              sh ./deploy/staging/deploy.sh
            fi
  test:
    working_directory: ~/rooms-booking
    environment:
      ADMIN_EMAIL: dung.hoduy@asnet.com.vn
      ADMIN_NAME: Dung Ho
      SMTP_EMAIL: nw.testing02@gmail.com
      SMTP_PASSWORD: abcde12345-
      SMTP_HOST: localhost:3000
      DATABASE_URL_TEST: postgres://ubuntu:@127.0.0.1:5432/room_booking_test
    docker:
      - image: circleci/ruby:2.3
        environment:
          RAILS_ENV: test
      - image: circleci/postgres:9.6-alpine
        environment:
          POSTGRES_USER: ubuntu
    steps:
      - checkout
      - restore_cache:
          keys:
            - gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum api/Gemfile.lock" }}
      - run:
          name: Install Ruby Dependencies
          command: cd api && bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3 && cd ..
      - save_cache:
          key: gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum api/Gemfile.lock" }}
          paths:
            - api/vendor/bundle
      - run:
          name: Install System Dependencies
          command: sudo apt-get update && sudo apt-get install -y --no-install-recommends build-essential libpq-dev
      - run:
          name: Create DB
          command: cd api && bundle exec rake db:create db:schema:load --trace && cd ..
      - run:
          name: Run spec
          command: cd api && bundle exec rspec spec && cd ..
          environment:
            RAILS_ENV: test
workflows:
  version: 2
  build-and-test:
    jobs:
      - deploy_to_gce

